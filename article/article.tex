\documentclass[12pt]{article}

\usepackage{setspace}
\onehalfspacing

\usepackage{natbib}
\bibliographystyle{apalike}

\usepackage[margin=1.0in]{geometry}

\usepackage{amsmath}

\usepackage{lineno}
\linenumbers

%opening
\title{A point-level trend model for the North American Breeding Bird Survey that corrects for detectability}
\author{
	Edwards, Brandon P.M.\\
	\and
	Johnston, Alison\\
	\and
	Miller, David L.\\
	\and
	Bennett, Joseph R.\\
	\and
	Smith, Adam C.\\
}

\begin{document}
	
	\maketitle
	
	%\begin{abstract}
		
%	\end{abstract}
	
\section{Introduction}
\par Data for the North American Breeding Bird Survey (BBS) have been collected since the 1960s when the BBS first started. The protocol has remained essentially the same since. Each year, observers run their BBS "route", which consists of 50, 3-minute point counts spaced roughly 800 m apart from each other. The observer is instructed to record every bird they see or hear within a 400m radius of each point, during each of the 3-minute point counts. Consider the spatially explicit hierarchical Bayesian trend model put forth in \citet{smith_spatially_2023} to model BBS data:

\begin{equation*}
	Y_{j,i,t,o} | \alpha_i, \delta_{i,t}, \gamma_{i,t}, \psi_j, \omega_o, \eta \sim NegBin(\lambda_{j,i,t,o}, \nu)
\end{equation*}
\begin{equation}\label{bbs}
\log(\lambda_{j,i,t,o}) = \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o}
\end{equation}

\par Counts $Y$ for each route $j$ in stratum $i$, at year $t$ observed by observer $o$ are modelled as realizations of a negative binomial distribution with mean $\lambda_{j,i,t,o}$ and inverse dispersion parameter $\nu$. On the log scale, values of $\lambda$ are modelled by intercepts representing mean count for each stratum ($\alpha_i$), route($\psi_j$), and observer ($\omega_o$), plus a temporal component $\delta_{i,t}$ that estimates population trajectory through time. Since the temporal component is a smoothed GAM, we also add in an annual fluctuation term $\gamma_{i,t}$ to allow for fluctuations from the smooth. We also have a first-year observer term $\eta$ that is present if the route $j$ in year $t$ is run by observer $o$ for the first time, and is zero otherwise. Finally, we also have a random noise term $\epsilon_{j,i,t,o}$.

Given the recent detectability offsets generated by the NA-POPS projet \citep{edwards_point_2023}, it would be useful to be able to incorporate these detectability offsets into the current BBS status and trends model. Incorporating these offsets can serve several purposes, from correcting for roadside biases \citep{thogmartin_sensitivity_2010, solymos_lessons_2020, edwards_point_2023}, to integrating disparate data sources \citep{solymos_calibrating_2013, edwards_point_2023}. However, because the current BBS model considers summed counts at the route level (rather than at the individual point level), we cannot yet directly apply these offsets to BBS data. Thus, this paper will describe a model that considers BBS data at the point-level such that detectability offsets can be incorporated into the model. Additionally, I will also derive a way to propagate the uncertainty from the estimated detectability probabilities from NA-POPS into the status and trends model.

\section{A Naive Point-level Model that Does Not Propagate Uncertainty}

Rather than modelling at the route-level $j$, we might try to model at the point-level (call this "point" $j$) such that we can incorporate a detectability offset directly at the point level from the NA-POPS database. The term $\psi_j$ would now represent a point-level random effect, and $\log(\lambda_{j,i,t,o})$ would represent the mean expected count at point $j$ in stratum $i$ during year $t$ by observer $o$. We can then include an offset from the NA-POPS database that corresponds to the duration of the survey at point $j$, year $t$, in stratum $i$ (which would usually be 3 minutes for a BBS count), as well as the maximum distance surveyed at that point (which would usually be 400 m for a BBS count). The offset would then be the multiplication of the components of detectability: availability $p$ and perceptibility $q$, as well as survey area $a$ \citep{solymos_calibrating_2013}. We then have

\begin{equation}\label{bbs_napops_novar}
	\log(\lambda_{j,i,t,o}) = \log(a p q)_{j,i,t,o} + \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o}
\end{equation}

By modelling at the point level rather than the route level, then we can still use the population index calculation used by \citet{smith_north_2020}:

$$
n_{i,t} = \dfrac{\sum_{j\in S_i}\exp(\alpha_i + \psi_j + \delta_{i,t})}{|S_i|}
$$

In other words, the index of abundance $n$ at stratum $i$ in year $t$ will be the exponentiated sum of the stratum effects $\alpha_i$, point effect $\psi_j$, and year effect $\delta_{i,t}$ for each point in stratum $S_i$, averaged over the number of points.

\section{Propagating Uncertainty Around Detectability Offset}
Although Equation \ref{bbs_napops_novar} now includes the detectability offset at the point level, it does not include the uncertainty around the estimate. However, \citet{bravington_variance_2021} gives us a method to propagate uncertainty for an offset into a GAM model. Consider the log offset term from Equation \ref{bbs_napops_novar}, $\log(apq)_{j,i,t,o}$. For now, let us consider the general case $\log(apq)$. Following \citet{bravington_variance_2021}, we can rewrite this offset term as follows:

\begin{equation}\label{offset}
	\log(apq) = log(a\hat{p} \hat{q}) + \kappa^{(p)}\zeta + O(\zeta^2) + \kappa^{(q)}\xi + O(\xi^2).
\end{equation}
	 
\par Here, $log(a \hat{p} \hat{q})$ is the log offset term with the estimated availability $\hat{p}$ and perceptibility $\hat{q}$ based on maximum likelihood methods from NA-POPS. We also introduce two additional sets of terms: $\kappa^{(p)}\zeta + O(\zeta^2)$ and $\kappa^{(q)}\xi + O(\xi^2)$, which are the corresponding uncertainty propagation terms for availability and perceptibility, respectively.  The parameters $zeta$ and $xi$ are basis coefficients for the variance propagation for $\hat{p}$ and $\hat{q}$, respectively, and play a similar role to that played by the basis coefficients in the GAM model \citep{bravington_variance_2021}. In a Bayesian context, we have that $\zeta \sim N(\boldsymbol{0}, \boldsymbol{V_p})$, where $V_p$ is the covariance matrix for $p(\theta)$ as determined through MLE methods; and $\xi \sim N(\boldsymbol{V_q})$, where $V_q$ is the covariance matrix for $q(\theta)$ as determined through MLE methods.

The design matrices for $\zeta$ and $\xi$, denoted here as $\kappa^{(p)}$ and $\kappa^{(q)}$, are both vectors that are obtained by taking the first partial derivatives of the log probabilities $p$ and $q$ and evaluating these at $\theta = \hat{\theta}$, i.e. at its maximum likelihood estimation. From \citet{solymos_calibrating_2013}, we have that availability $p(\theta) = 1 - \exp\left\{-t\phi\right\}$, where $\phi = \exp\left(\theta\right)$ represents the cue rate for a given species, regressed against various factors that affect cue rate (such as ordinal day, time since sunrise, or their quadratic terms). If we have a vector {\boldmath$\beta$} of $S$ parameters and a design matrix $X$, we can set $\theta = X\boldsymbol{\beta}$, and find that the first partial derivative with respect to $\beta_s$, $s \in \left[0, S\right]$, and hence the $s$th entry of the design matrix $\kappa^{(p)}$, is given by
\begin{equation*}\label{kappa_p}
	\kappa_{s}^{(p)} = \left.\dfrac{\partial \log p(\theta)}{\partial \beta_s}\right\vert_{\theta = \hat{\theta}} = \left. X_s \times \dfrac{t \exp\left\{X\boldsymbol{\beta}\right\}}{\exp\left\{t \exp\left\{X\boldsymbol{\beta}\right\}\right\} - 1} \right\vert_{\beta = \hat{\beta}}
\end{equation*}

%For the simple case of an intercept-only model, we find that the first partial derivative with respect to $\beta_0$ (the intercept term) is given by:
%\begin{equation*}
%	\dfrac{\partial \log p(\theta)}{\partial \beta_0} = \dfrac{t \exp\left\{\beta_0\right\}}{\exp\left\{t \exp\left\{\beta_0\right\}\right\} - 1}.
%	\end{equation*}

	
If we now consider perceptibility, from \citet{solymos_calibrating_2013}, we have that perceptibility $q(\theta) = \dfrac{\pi \tau^2 \left\{1 - \exp\left(\dfrac{-r^2}{\tau^2}\right)\right\}}{\pi r^2}$, where $\tau = \exp(\theta)$ represents the effective detection radius for a given species, regressed against various factors that could effect effective detection radius (such as survey roadside status and forest coverage). If we have a vector {\boldmath$\beta$} of $S$ parameters and a design matrix $X$, we can set $\theta = X\boldsymbol{\beta}$, and find that the first partial derivative with respect to $\beta_s$, $s \in \left[0, S\right]$, and hence the $s$th entry of the design matrix $\kappa^{(q)}$, is given by

%For the (not so) simple case of an intercept-only model, we find that the first partial derivative with respect to $\beta_0$ (the intercept term) is given by:

%\begin{equation*}
%	\dfrac{\partial \log q(\theta)}{\partial \beta_0} = \dfrac{{e^{-2\beta_0}} {2 \pi e^{2\beta_0}} {\left(1 - e^{r^2 \left(-e^{-2\beta_0}\right)}\right)} - {2\pi r^2} {e^{r^2 \left(-e^{-2\beta_0}\right)}}}             {\pi {1-e^{r^2 \left(-e^{-2\beta_0}\right)}}} - log(\pi^2r^2)
%\end{equation*}

\begin{equation*}\label{kappa_q}
	\kappa_{s}^{(q)} = \left. \dfrac{\partial \log q(\theta)}{\partial \beta_s} \right\vert_{\theta = \hat{\theta}}= \left. X_s \left[\dfrac{{e^{-2X\boldsymbol{\beta}}} {2 \pi  e^{2X\boldsymbol{\beta}}} {\left(1 - e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}\right)} - {2\pi r^2} {e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}}}             {\pi {1-e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}}}\right]  - log(\pi^2r^2) \right\vert_{\beta = \hat{\beta}}
\end{equation*}

Finally, the terms $O(\zeta^2)$ and $O(\xi^2)$ arise from the Taylor approximations that are used to arrive at Equation \ref{offset} \citep{bravington_variance_2021}. Since we only use the Taylor approximations up to the 2nd term of the Taylor series, our offset term is asymptotically accurate to $O(\zeta^2) + O(\xi^2) = O(\zeta^2 + \xi^2)$.

Putting everything together, we arrive at the following point-level model that includes the log offset term and variance propagation terms:
\begin{equation}\label{bbs_varprop}
	\log(\lambda_{j,i,t,o}) = \log(a \hat{p} \hat{q})_{j,i,t,o} + \kappa_{j,i,t,o}^{(p)}\zeta + \kappa_{j,i,t,o}^{(q)}\xi + \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o} + O(\zeta^2 + \xi^2) \\
\end{equation}


	\bibliography{refs}
\end{document}
